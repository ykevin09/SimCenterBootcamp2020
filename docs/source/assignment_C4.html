

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>C: Parallel Programming &mdash; Programming Bootcamp 2020  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/hacks.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="C: Tapis-cli" href="assignment_C5.html" />
    <link rel="prev" title="C++ Exercises" href="assignment_C3.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Programming Bootcamp 2020
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="setupInstructions.html">Setup Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture_videos.html">Self-Study Videos</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="assignments.html">Assignments</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="assignment_day1.html">Python: Assignments Day 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_day2.html">Python: Assignments Day 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_day3.html">Python: Assignments Day 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_day4.html">Python: Assignments Day 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_day5.html">Python: Assignments Day 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignmentPreC.html">C: Assignment to Test Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_C1.html">C Variables and Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_C2_solution.html">C: Day 2 In Class Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="assignment_C3.html">C++ Exercises</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">C: Parallel Programming</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#problem-1-parallelize-using-mpi">Problem 1: Parallelize using <strong>MPI</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#problem-2-parallelize-using-openmp">Problem 2: Parallelize using OpenMP</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="assignment_C5.html">C: Tapis-cli</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="TACC.html">TACC-Frontera</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="emacs.html">Emacs</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Questions, Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Additional Resources</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Programming Bootcamp 2020</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="assignments.html">Assignments</a> &raquo;</li>
        
      <li>C: Parallel Programming</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/source/assignment_C4.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="c-parallel-programming">
<h1>C: Parallel Programming<a class="headerlink" href="#c-parallel-programming" title="Permalink to this headline">¶</a></h1>
<p>Today we have two problems for you to tackle. They both parallelize the <strong>pi.c</strong> code you developed for day 1. Both programs will need to be compiled at one of the TACC supercomputers.</p>
<p>The figure below shows an method to compute <strong>pi</strong> by numerical integration. We would like you to implement that computation in a <strong>C</strong> program.</p>
<blockquote>
<div><div class="align-center figure" id="id1">
<img alt="../_images/pi.png" src="../_images/pi.png" />
<p class="caption"><span class="caption-text">Computation of pi numerically</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
<p>The solution <a class="reference external" href="https://github.com/NHERI-SimCenter/SimCenterBootcamp2020/tree/master/code/c/ExerciseDay1/assignments/pi.c">pi.c</a> can be found on github. The contents of that file is presented here:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">numSteps</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// perform calculation</span>
  <span class="kt">double</span> <span class="n">pi</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">numSteps</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.50</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pi</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>
  
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PI = %16.14f Difference from math.h definition %16.14f </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-</span><span class="n">M_PI</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>When compiling at TACC if you wish to use <strong>gcc</strong> as I have done, issue the following command when you login.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">gcc</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>When building and testing that the application works, use <strong>idev</strong>, as I have been showing in the videos.</p></li>
<li><p>When launchig the job to test the performance you will need to use <strong>sbatch</strong> and place your job in the queue. To do this you need to create a script that will be launched when the job runs. I have placed two scripts in each of the file folders. The script informs the system how many nodes and cores per node, what the expected run time is, and how to run the jib. Once the executable exists, the job is launched using the following command issued from a <strong>login</strong> node:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbatch</span> <span class="n">submit</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div></blockquote>
<p>Full documentation on submitting scripts for <strong>OpenMP</strong> and <strong>MPI</strong> can be found <a class="reference external" href="https://frontera-portal.tacc.utexas.edu/user-guide/scripts/">online at TACC</a></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Our solution of <strong>pi.c</strong> as written as a loop dependency which may need to revise for the second problem.</p>
</div>
<div class="section" id="problem-1-parallelize-using-mpi">
<h2>Problem 1: Parallelize using <strong>MPI</strong><a class="headerlink" href="#problem-1-parallelize-using-mpi" title="Permalink to this headline">¶</a></h2>
<p>You are to modify the <strong>pi.c</strong> application and run it to use mpi. I have included a few files in code/parallel/ExercisesDay4/ex1 to help you. They include <strong>pi.c</strong> above, gather1.c and a submit.sh script. <strong>gather1.c</strong> was presented in the video, and us shown below:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#define LUMP 5</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="kt">int</span> <span class="n">numP</span><span class="p">,</span> <span class="n">procID</span><span class="p">;</span>

  <span class="c1">// the usual mpi initialization</span>
  <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
  <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numP</span><span class="p">);</span>
  <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">procID</span><span class="p">);</span>

  <span class="kt">int</span> <span class="o">*</span><span class="n">globalData</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">localData</span><span class="p">[</span><span class="n">LUMP</span><span class="p">];</span>

  <span class="c1">// process 0 is only 1 that needs global data</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">procID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">globalData</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">LUMP</span> <span class="o">*</span> <span class="n">numP</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">LUMP</span><span class="o">*</span><span class="n">numP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">globalData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">LUMP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">localData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">procID</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
  
  <span class="n">MPI_Gather</span><span class="p">(</span><span class="n">localData</span><span class="p">,</span> <span class="n">LUMP</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">globalData</span><span class="p">,</span> <span class="n">LUMP</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">procID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numP</span><span class="o">*</span><span class="n">LUMP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">globalData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">procID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="n">globalData</span><span class="p">);</span>

  <span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The submit script is as shown below.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#--------------------------------------------------------------------</span>
<span class="c1"># Generic SLURM script – MPI Hello World</span>
<span class="c1">#</span>
<span class="c1"># This script requests 1 node and 8 cores/node (out of total 64 avail)</span>
<span class="c1"># for a total of 1*8 = 8 MPI tasks.</span>
<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1">#SBATCH -J myjob</span>
<span class="c1">#SBATCH -o myjob.%j.out </span>
<span class="c1">#SBATCH -e myjob.%j.err </span>
<span class="c1">#SBATCH -p development</span>
<span class="c1">#SBATCH -N 1</span>
<span class="c1">#SBATCH -n 4</span>
<span class="c1">#SBATCH -t 00:02:00</span>
<span class="c1">#SBATCH -A DesignSafe-SimCenter</span>

<span class="n">ibrun</span> <span class="o">./</span><span class="n">pi</span>


</pre></div>
</td></tr></table></div>
<p>One possible solution, which includes multiple approaches, is as shown in the following:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">#include &lt;mpi.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;time.h&gt;</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">long</span> <span class="n">numSteps</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="nb">int</span> <span class="n">numP</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">the</span> <span class="n">usual</span> <span class="n">mpi</span> <span class="n">initialization</span>
  <span class="o">//</span>

  <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
  <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numP</span><span class="p">);</span>
  <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">start</span> <span class="n">timer</span>
  <span class="o">//</span>

  <span class="n">clock_t</span> <span class="n">start_t</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">init</span> <span class="n">some</span> <span class="n">variable</span>
  <span class="o">//</span>

  <span class="n">double</span> <span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">double</span><span class="p">)</span> <span class="n">numSteps</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">compute</span> <span class="n">processors</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">pi</span>
  <span class="o">//</span>

  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="n">pid</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">numP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">;</span>
    <span class="n">pi</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">gather</span> <span class="n">contributions</span> <span class="n">on</span> <span class="n">P0</span> <span class="o">&amp;</span> <span class="nb">sum</span>
  <span class="o">//</span>

  <span class="n">double</span> <span class="o">*</span><span class="n">globalSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">globalSum</span> <span class="o">=</span> <span class="p">(</span><span class="n">double</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numP</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">MPI_Gather</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="n">globalSum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">//</span> <span class="mi">0</span> <span class="k">as</span> <span class="n">pi</span> <span class="n">already</span> <span class="k">as</span> <span class="n">p0</span> <span class="n">contribution</span>
      <span class="n">pi</span> <span class="o">+=</span> <span class="n">globalSum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="n">globalSum</span><span class="p">);</span>
  
  <span class="o">//</span> 
  <span class="o">//</span> <span class="n">end</span> <span class="n">timer</span>
  <span class="o">//</span>

  <span class="n">clock_t</span> <span class="n">end_t</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
  <span class="n">double</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">double</span><span class="p">)(</span><span class="n">end_t</span> <span class="o">-</span> <span class="n">start_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">CLOCKS_PER_SEC</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;PI = </span><span class="si">%16.8f</span><span class="s2">, duration: </span><span class="si">%f</span><span class="s2"> s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>

  <span class="o">//</span> 
  <span class="o">//</span> <span class="n">usual</span> <span class="n">termination</span> <span class="k">for</span> <span class="n">MPI</span>
  <span class="o">//</span>

  <span class="n">MPI_Finalize</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="problem-2-parallelize-using-openmp">
<h2>Problem 2: Parallelize using OpenMP<a class="headerlink" href="#problem-2-parallelize-using-openmp" title="Permalink to this headline">¶</a></h2>
<p>You are to modify the <strong>pi.c</strong> application and run it to use mpi. I have included a few files in code/parallel/ExercisesDay4/ex1 to help you. They include <strong>pi.c</strong> above and submitPI.sh script. <strong>submitPI.sh</strong> is as shown:</p>
<p>One possible solution, which includes multiple approaches, is as shown in the following:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">file</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">pi</span> <span class="n">numerically</span> <span class="n">using</span> <span class="n">a</span> <span class="n">number</span> <span class="n">of</span> <span class="n">different</span> <span class="n">approaches</span>
<span class="o">//</span>   <span class="o">-</span> <span class="n">demonstrates</span> <span class="n">various</span> <span class="n">OpenMP</span> <span class="n">approaches</span>

<span class="c1">#include &lt;omp.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;time.h&gt;</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">long</span> <span class="n">numSteps</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="o">//</span> <span class="n">perform</span> <span class="n">calculation</span>
  <span class="n">double</span> <span class="n">pi</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">numSteps</span><span class="p">;</span>
  <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">compute</span> <span class="n">Serially</span>
  <span class="o">//</span>

  <span class="n">double</span> <span class="n">start</span> <span class="o">=</span> <span class="n">omp_get_wtime</span><span class="p">();</span>  
  <span class="p">{</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">double</span> <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.50</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">pi</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
      <span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pi</span><span class="o">*=</span><span class="n">dx</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Serial: PI = </span><span class="si">%16.8f</span><span class="s2"> in </span><span class="si">%.4g</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">omp_get_wtime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>

  <span class="o">//</span>  
  <span class="o">//</span> <span class="n">Compute</span> <span class="ow">in</span> <span class="n">Parallel</span> <span class="k">with</span> <span class="n">false</span> <span class="n">sharing</span> <span class="n">issue</span>
  <span class="o">//</span>

  <span class="n">start</span> <span class="o">=</span> <span class="n">omp_get_wtime</span><span class="p">();</span>  
  <span class="nb">int</span> <span class="n">nThreads</span><span class="p">;</span>
  <span class="n">double</span> <span class="n">pSum</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
    <span class="n">pSum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">#pragma omp parallel </span>
  <span class="p">{</span>
    <span class="nb">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span>
    <span class="nb">int</span> <span class="n">numT</span> <span class="o">=</span> <span class="n">omp_get_num_threads</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">nThreads</span> <span class="o">=</span> <span class="n">numT</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="n">tid</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">numT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">;</span>  
      <span class="n">pSum</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>  <span class="o">//</span> <span class="n">line</span> <span class="k">with</span> <span class="n">false</span> <span class="n">sharing</span> <span class="n">issue</span>
    <span class="p">}</span>
  <span class="p">}</span>  

  <span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nThreads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pi</span> <span class="o">+=</span> <span class="n">pSum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parallel Results: </span><span class="si">%d</span><span class="s2"> Threads</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">nThreads</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Basic False Sharing: PI = </span><span class="si">%16.8f</span><span class="s2"> in </span><span class="si">%.4g</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">omp_get_wtime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>  


  <span class="o">//</span>
  <span class="o">//</span> <span class="n">Basic</span> <span class="k">with</span> <span class="n">padded</span> <span class="n">array</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">false</span> <span class="n">sharing</span>
  <span class="o">//</span>  
  
  <span class="n">start</span> <span class="o">=</span> <span class="n">omp_get_wtime</span><span class="p">();</span>

  <span class="n">double</span> <span class="n">padSum</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="mi">64</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nThreads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
    <span class="n">padSum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">#pragma omp parallel </span>
  <span class="p">{</span>
    <span class="nb">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span>
    <span class="nb">int</span> <span class="n">numT</span> <span class="o">=</span> <span class="n">omp_get_num_threads</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">nThreads</span> <span class="o">=</span> <span class="n">numT</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="n">tid</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">numT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">;</span>  
      <span class="n">padSum</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>  <span class="o">//</span> <span class="n">padSum</span> <span class="o">..</span> <span class="n">now</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">assesing</span>
                                      <span class="o">//</span>   <span class="n">array</span> <span class="n">values</span> <span class="nb">next</span> <span class="n">to</span> <span class="n">each</span> <span class="n">other</span>
    <span class="p">}</span>
  <span class="p">}</span>  

  <span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nThreads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pi</span> <span class="o">+=</span> <span class="n">padSum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Fix Previous with array padding: PI = </span><span class="si">%16.8f</span><span class="s2"> in </span><span class="si">%.4g</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">omp_get_wtime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>  


  <span class="o">//</span>
  <span class="o">//</span> <span class="n">Demonstration</span> <span class="c1">#omp parallel for reduction</span>
  <span class="o">//</span>     
  
  <span class="n">start</span> <span class="o">=</span> <span class="n">omp_get_wtime</span><span class="p">();</span>

<span class="c1">#pragma omp parallel for reduction(+:pi) private(x)</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">;</span>  
    <span class="n">pi</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>
  
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Reduction: PI = </span><span class="si">%16.8f</span><span class="s2"> in </span><span class="si">%.4g</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">omp_get_wtime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">Replace</span> <span class="n">Reduction</span> <span class="k">with</span> <span class="n">Synchronization</span> <span class="n">section</span><span class="p">:</span> <span class="n">critical</span>
  <span class="o">//</span>
  
  <span class="n">start</span> <span class="o">=</span> <span class="n">omp_get_wtime</span><span class="p">();</span>  
<span class="c1">#pragma omp parallel </span>
  <span class="p">{</span>
    <span class="n">double</span> <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">#pragma omp for</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numSteps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">;</span>
      <span class="nb">sum</span> <span class="o">+=</span> <span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
<span class="c1">#pragma omp critical</span>
    <span class="p">{</span>
      <span class="n">pi</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">;</span>
      <span class="o">//</span> <span class="n">OTHER</span> <span class="n">STUFF</span> <span class="n">IF</span> <span class="n">YOU</span> <span class="n">WANT</span> <span class="o">..</span> <span class="n">NOT</span> <span class="n">TOO</span> <span class="n">MUCH</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="n">pi</span> <span class="o">*=</span> <span class="n">dx</span><span class="p">;</span>
  
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Synchronization: PI = </span><span class="si">%16.8f</span><span class="s2"> in </span><span class="si">%.4g</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span> <span class="n">omp_get_wtime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="assignment_C5.html" class="btn btn-neutral float-right" title="C: Tapis-cli" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="assignment_C3.html" class="btn btn-neutral float-left" title="C++ Exercises" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Peter Mackenzie-Helnwein, Frank McKenna

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>